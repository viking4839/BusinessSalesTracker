// utils/PDFExport.js

import { Platform } from 'react-native';
import { Share } from 'react-native';

class PDFExport {
    static async generateProfitReportPDF(reportData, inventoryStats) {
        try {
            const today = new Date().toISOString().split('T')[0];

            // Validate report data
            PDFExport.validateReportData(reportData);

            // Create a simple text-based report (in real app, use a proper PDF library)
            const reportContent = this.generateReportContent(reportData, inventoryStats, today);

            // For now, we'll share as text file. In production, use react-native-html-to-pdf
            const shareOptions = {
                title: `Profit Report - ${today}`,
                message: reportContent,
                subject: `Profit Margin Report - ${today}`,
            };

            await Share.open(shareOptions);
            return true;
        } catch (error) {
            console.error('PDF Export error:', error);
            throw new Error('Failed to generate report');
        }
    }

    static generateReportContent(report, inventoryStats, date) {
        const header = `
ðŸª TRACK BIZ - PROFIT MARGIN REPORT
ðŸ“… Date: ${date}
â° Generated: ${new Date().toLocaleString()}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    `.trim();

        const summary = `
ðŸ’° DAILY SUMMARY:
â€¢ Total Sales: Ksh ${report?.totalSales?.toLocaleString() || '0'}
â€¢ Cost of Goods: Ksh ${report?.totalCost?.toLocaleString() || '0'}
â€¢ Gross Profit: Ksh ${report?.totalProfit?.toLocaleString() || '0'}
â€¢ Profit Margin: ${report?.margin || '0'}%
â€¢ Transactions: ${report?.transactionCount || '0'}
    `.trim();

        let itemsBreakdown = '';
        if (report?.items && report.items.length > 0) {
            itemsBreakdown = '\n\nðŸ“Š ITEMIZED BREAKDOWN:\n';
            itemsBreakdown += 'Item'.padEnd(20) + 'Sold'.padEnd(8) + 'Retail'.padEnd(12) + 'Cost'.padEnd(12) + 'Profit\n';
            itemsBreakdown += 'â”€'.repeat(60) + '\n';

            report.items.forEach(item => {
                itemsBreakdown +=
                    item.name.substring(0, 18).padEnd(20) +
                    String(item.sold).padEnd(8) +
                    `Ksh ${item.retailPrice}`.padEnd(12) +
                    `Ksh ${item.wholesalePrice}`.padEnd(12) +
                    `Ksh ${item.profit.toLocaleString()}\n`;
            });
        }

        let inventorySection = '';
        if (inventoryStats) {
            inventorySection = `
        
ðŸ“¦ INVENTORY INSIGHTS:
â€¢ Total Stock Value: Ksh ${inventoryStats.totalStockValue?.toLocaleString() || '0'}
â€¢ Total Cost Value: Ksh ${inventoryStats.totalCostValue?.toLocaleString() || '0'}
â€¢ Potential Profit: Ksh ${inventoryStats.totalPotentialProfit?.toLocaleString() || '0'}
â€¢ Active Items: ${inventoryStats.activeItems || '0'}
      `.trim();

            if (inventoryStats.bestValueItems.length > 0) {
                inventorySection += '\n\nðŸ† BEST VALUE ITEMS:';
                inventoryStats.bestValueItems.forEach((item, index) => {
                    inventorySection += `\n${index + 1}. ${item.name} - Ksh ${(item.unitPrice - item.wholesalePrice).toLocaleString()} profit (${item.profitMargin}% margin)`;
                });
            }

            if (inventoryStats.lowMarginItems.length > 0) {
                inventorySection += '\n\nâš ï¸ LOW MARGIN ALERTS:';
                inventoryStats.lowMarginItems.forEach(item => {
                    inventorySection += `\nâ€¢ ${item.name} - ${item.profitMargin}% margin`;
                });
            }
        }

        const footer = `
        
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ðŸ“± Generated by Track Biz App
ðŸ”’ Secure & Encrypted
    `.trim();

        return header + '\n' + summary + itemsBreakdown + inventorySection + footer;
    }

    static async exportWeeklyReport(weeklyReports) {
        try {
            const today = new Date().toISOString().split('T')[0];

            let reportContent = `
ðŸª TRACK BIZ - WEEKLY PROFIT REPORT
ðŸ“… Period: ${today} (Last 7 Days)
â° Generated: ${new Date().toLocaleString()}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      `.trim();

            Object.entries(weeklyReports).forEach(([date, report]) => {
                reportContent += `\n\nðŸ“… ${date}:`;
                reportContent += `\nâ€¢ Sales: Ksh ${report.totalSales?.toLocaleString() || '0'}`;
                reportContent += `\nâ€¢ Profit: Ksh ${report.totalProfit?.toLocaleString() || '0'}`;
                reportContent += `\nâ€¢ Margin: ${report.margin || '0'}%`;
                reportContent += `\nâ€¢ Transactions: ${report.transactionCount || '0'}`;

                if (report.bestSellingItem) {
                    reportContent += `\nâ€¢ Best Seller: ${report.bestSellingItem.name} (${report.bestSellingItem.sold} sold)`;
                }
            });

            const shareOptions = {
                title: `Weekly Profit Report - ${today}`,
                message: reportContent,
                subject: `Weekly Profit Margin Report - ${today}`,
            };

            await Share.share(shareOptions);
            return true;
        } catch (error) {
            console.error('Weekly export error:', error);
            throw new Error('Failed to generate weekly report');
        }
    }

    static validateReportData(reportData) {
        if (!reportData) {
            throw new Error('No report data provided');
        }
        if (typeof reportData !== 'object') {
            throw new Error('Invalid report data format');
        }
        // Check for essential fields
        const requiredFields = ['totalSales', 'totalCost', 'totalProfit', 'margin'];
        const missingFields = requiredFields.filter(field => reportData[field] === undefined);
        if (missingFields.length > 0) {
            console.warn('Missing fields in report data:', missingFields);
        }
        return true;
    }
}

export default PDFExport;